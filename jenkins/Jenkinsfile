pipeline {
	agent any
    parameters {
		string(name: 'BROWSER', defaultValue: 'chrome', description: '–í—ã–±–µ—Ä–∏—Ç–µ –±—Ä–∞—É–∑–µ—Ä (chrome/firefox)')
    }
    environment {
		ALLURE_HOME = "/opt/homebrew/bin/allure"
        MAVEN_HOME = "/opt/homebrew/bin/mvn"
        TELEGRAM_BOT_TOKEN = "8040905753:AAEeindN9glf1rRMHxj_Na0cbVsxfiY1T-E"
        TELEGRAM_CHAT_ID = "7873857"
        SLACK_WEBHOOK_URL = "https://hooks.slack.com/services/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"
        PATH = "${ALLURE_HOME}:${env.PATH}"
    }
    stages {
		stage('Checkout') {
			steps {
				git branch: 'main', url: 'https://github.com/PetFactory1991/JavaSelenideJenkinsAllureDockerSelenoid.git'
            }
        }
        stage('Cache Maven Dependencies') {
			steps {
				sh "${MAVEN_HOME} dependency:go-offline"
            }
        }
        stage('Run Tests') {
			steps {
				script {
					catchError(buildResult: 'FAILURE', stageResult: 'FAILURE') {
						sh "${MAVEN_HOME} clean test -Dbrowser=${params.BROWSER} -Dremote=http://165.22.93.142:4444/wd/hub"
                    }
                }
            }
        }
        stage('Generate Allure Report') {
			steps {
				sh "${ALLURE_HOME} generate allure-results -o allure-report --clean"
            }
        }
    }
    post {
		always {
			script {
				def summary = readJSON file: 'allure-report/widgets/summary.json'

                def totalTests = summary.statistic.total
                def passedTests = summary.statistic.passed
                def failedTests = summary.statistic.failed
                def brokenTests = summary.statistic.broken
                def skippedTests = summary.statistic.skipped
                def durationMs = summary.time.duration
                def durationSec = (durationMs / 1000).toInteger()
                def durationMin = durationSec / 60 as int
                def durationRemainingSec = durationSec % 60 as int

                def statusEmoji = (currentBuild.result == "SUCCESS") ? "üü¢" : "üî¥"
                def allureReportUrl = "${env.BUILD_URL}/allure"

                def commitHash = sh(script: "git rev-parse HEAD", returnStdout: true).trim()
                def author = sh(script: "git show -s --pretty='%an'", returnStdout: true).trim()
                def commitMessage = sh(script: "git log -1 --pretty=%B", returnStdout: true).trim()
                def commitUrl = "https://github.com/PetFactory1991/JavaSelenideJenkinsAllureDockerSelenoid/commit/${commitHash}"

                def message = """üîπ *Jenkins Report* üîπ
üìå *Job:* ${env.JOB_NAME} #${env.BUILD_NUMBER}
üë§ *–ê–≤—Ç–æ—Ä:* ${author}
üí¨ *–ö–æ–º–º–∏—Ç:* [${commitHash.take(7)}](${commitUrl}) ‚Äî ${commitMessage}
üåç *Browser:* ${params.BROWSER.toUpperCase()} | Remote: 165.22.93.142
üîó [Allure Report](${allureReportUrl})

üìä *–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤:* ${totalTests}
‚úÖ *–ü—Ä–æ—à–ª–æ:* ${passedTests}
‚ùå *–£–ø–∞–ª–æ:* ${failedTests}
‚ö†Ô∏è *–°–ª–æ–º–∞–Ω–æ:* ${brokenTests}
‚è© *–ü—Ä–æ–ø—É—â–µ–Ω–æ:* ${skippedTests}

‚è± *–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:* ${durationSec} —Å–µ–∫ (${durationMin} –º–∏–Ω ${durationRemainingSec} —Å–µ–∫)

${statusEmoji} *–°—Ç–∞—Ç—É—Å:* ${currentBuild.result}"""

                // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram
                sh """
                    curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
                    -d chat_id=${TELEGRAM_CHAT_ID} \
                    -d text="${message}" \
                    -d parse_mode="Markdown" \
                    -d disable_web_page_preview=true
                """

                // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Slack
                def slackMessage = [
                    text: "*Jenkins Report* ${statusEmoji}",
                    attachments: [[
                        color: (currentBuild.result == "SUCCESS") ? "good" : "danger",
                        fields: [
                            [title: "Job", value: "${env.JOB_NAME} #${env.BUILD_NUMBER}", short: true],
                            [title: "Browser", value: "${params.BROWSER.toUpperCase()}", short: true],
                            [title: "–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤", value: "${totalTests}", short: true],
                            [title: "‚úÖ –ü—Ä–æ—à–ª–æ", value: "${passedTests}", short: true],
                            [title: "‚ùå –£–ø–∞–ª–æ", value: "${failedTests}", short: true],
                            [title: "‚è± –í—Ä–µ–º—è", value: "${durationMin} –º–∏–Ω ${durationRemainingSec} —Å–µ–∫", short: true],
                            [title: "–ê–≤—Ç–æ—Ä", value: "${author}", short: true],
                            [title: "–ö–æ–º–º–∏—Ç", value: "<${commitUrl}|${commitHash.take(7)}> ‚Äî ${commitMessage}", short: false],
                            [title: "Allure Report", value: "<${allureReportUrl}|–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ—Ç—á—ë—Ç—É>", short: false]
                        ]
                    ]]
                ]

                writeJSON file: 'slackMessage.json', json: slackMessage, pretty: 4

                sh """
                    curl -X POST -H 'Content-type: application/json' \
                    --data @slackMessage.json \
                    ${SLACK_WEBHOOK_URL}
                """
            }

            allure includeProperties: false, results: [[path: "allure-results"]]
        }
    }
}
